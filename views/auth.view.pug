extends layout

block content
    // Container for both forms
    .container.mt-3.mt-sm-5.pt-sm-5
        .row.justify-content-between
            // Hide when smaller than md
            .col-md-6.d-none.d-md-block.px-5
                .d-flex.flex-column.justify-content-center.align-items-center.h-100(style='background-color: rgba(0, 0, 0, 0.5);')
                    h1.text-white.display-4.mb-3 #{__("Welcome to Ziyi LIU")}
                    p.text-white.lead #{__("Experience creativity and innovation in every click.")}
            .col-md-5
                //--- LOGIN FORM (shown by default) ---
                .w-100.w-sm-75
                    form#loginForm(action='/auth/login' method='POST')
                        input(type='hidden' name='_csrf' value=csrfToken)
                        // Heading
                        h2.mb-3 &#x1F44B;
                        h2.mb-3 #{__("Welcome back!")}

                        // Email field
                        .d-flex.justify-content-between.align-items-center.m-auto.p-auto.mb-2
                            label(for="loginEmail") #{__("Email")}
                        .form-group.mb-2.mb-sm-3
                            input.form-control#loginEmail(
                                type="email"
                                name="email"
                                required
                                placeholder=__("Enter your email")
                            )
                            .invalid-feedback#loginEmailError

                        // Password + "forgot password?" link
                        .d-flex.flex-wrap.justify-content-between.align-items-center.m-auto.p-auto.mb-2
                            label(for="loginPassword") #{__("Password")}
                            a.forgot-password(href="#") #{__("Forgot password?")}
                        .form-group.mb-2.mb-sm-3
                            input.form-control#loginPassword(
                                type="password"
                                name="password"
                                required
                                placeholder=__("Enter your password")
                            )
                            .invalid-feedback#loginPasswordError

                        // Keep me logged in checkbox
                        .form-check.mb-2.mb-sm-4
                            input.form-check-input(type="checkbox" id="keepLoggedIn" name="keepLoggedIn")
                            label.form-check-label(for="keepLoggedIn") #{__("Keep me logged in")}

                        // Sign In button
                        .d-grid.m-auto.p-auto.mt-2.mt-sm-5
                            button.btn.btn-primary.btn-block(type="submit" disabled) #{__("Log in")}

                        // Toggle link
                        p.mt-2
                            span.text-muted
                                | #{__("Donâ€™t have an account?")} &nbsp;
                            a#showSignup(href="#signup") #{__("Sign up")}

                .w-100
                    //--- SIGNUP FORM (hidden by default) ---
                    form#signupForm(action='/auth/signup' method='POST' style='display:none;')
                        input(type='hidden' name='_csrf' value=csrfToken)
                        // Heading
                        h2.mb-3 #{__("Let's get started...")}

                        // Name row
                        .row.mb-0
                            .mb-2.mb-sm-4.col-md-6
                                .d-flex.justify-content-between.align-items-center.m-auto.p-auto.mb-2
                                    label(for="signupFirstName") #{__("First Name")}
                                .form-group.m-auto.p-auto.mb-0
                                    input.form-control#signupFirstName(
                                        type="text"
                                        name="first_name"
                                        required
                                        placeholder=__("Enter your first name")
                                    )
                                    .invalid-feedback#signupFirstNameError
                            .mb-2.mb-sm-4.col-md-6
                                .d-flex.justify-content-between.align-items-center.m-auto.p-auto.mb-2
                                    label(for="signupLastName") #{__("Last Name")}
                                .form-group.m-auto.p-auto.mb-0
                                    input.form-control#signupLastName(
                                        type="text"
                                        name="last_name"
                                        required
                                        placeholder=__("Enter your last name")
                                    )
                                    .invalid-feedback#signupLastNameError

                        // Email
                        .d-flex.justify-content-between.align-items-center.m-auto.p-auto.mb-2
                            label(for="signupEmail") #{__("Email")}
                        .form-group.mb-2.mb-sm-3
                            input.form-control#signupEmail(
                                type="email"
                                name="email"
                                required
                                placeholder=__("Enter your email")
                            )
                            .invalid-feedback#signupEmailError

                        // Password
                        .d-flex.justify-content-between.align-items-center.m-auto.p-auto.mb-2
                            label(for="signupPassword") #{__("Password")}
                        .form-group.mb-2.mb-sm-3
                            input.form-control#signupPassword(
                                type="password"
                                name="password"
                                required
                                placeholder=__("Enter your password")
                            )
                            .invalid-feedback#signupPasswordError

                        // Confirm password
                        .d-flex.justify-content-between.align-items-center.m-auto.p-auto.mb-2
                            label(for="signupConfirmPassword") #{__("Confirm Password")}
                        .form-group.mb-2.mb-sm-3
                            input.form-control#signupConfirmPassword(
                                type="password"
                                name="confirm_password"
                                required
                                placeholder=__("Confirm your password")
                            )
                            .invalid-feedback#signupConfirmPasswordError

                        // Create account button
                        .d-grid.m-auto.p-auto.mt-2.mt-sm-5
                            button.btn.btn-secondary.btn-block(type="submit" disabled) #{__("Create my account")}

                        // Toggle link
                        p.mt-2
                            span.text-muted
                                | #{__("Already a member?")} &nbsp;
                            a#showLogin(href="#login") #{__("Log in")}

    // Toggle and reset script
    script.
        document.addEventListener("DOMContentLoaded", function () {
            const showSignup = document.getElementById("showSignup");
            const showLogin = document.getElementById("showLogin");
            const loginForm = document.getElementById("loginForm");
            const signupForm = document.getElementById("signupForm");

            // Function to reset form fields, errors, and touched state
            function resetForm(form) {
                form.reset();
                // Remove error classes and clear error messages
                form.querySelectorAll('.is-valid').forEach(input => input.classList.remove('is-valid'));
                form.querySelectorAll('.is-invalid').forEach(input => input.classList.remove('is-invalid'));
                form.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = "");
                // Clear the "touched" flag on all inputs
                form.querySelectorAll('input').forEach(input => {
                    delete input.dataset.touched;
                });
                // Disable submit button
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    // submitBtn.disabled = true;
                    submitBtn.classList.add('disabled');
                }
            }

            // Function to display the proper form based on the URL hash
            function showFormFromHash() {
                if (window.location.hash === '#signup') {
                    loginForm.style.display = "none";
                    resetForm(loginForm);
                    signupForm.style.display = "block";
                    resetForm(signupForm);
                } else {
                    signupForm.style.display = "none";
                    resetForm(signupForm);
                    loginForm.style.display = "block";
                    resetForm(loginForm);
                }
            }

            // Toggle links update the hash, which triggers the proper form display
            if (showSignup && showLogin && loginForm && signupForm) {
                showSignup.addEventListener("click", function (event) {
                    event.preventDefault();
                    window.location.hash = "#signup";
                    showFormFromHash();
                });
                showLogin.addEventListener("click", function (event) {
                    event.preventDefault();
                    window.location.hash = "#login";
                    showFormFromHash();
                });
            }

            // Listen for hash changes (e.g., when the user navigates with browser buttons)
            window.addEventListener("hashchange", showFormFromHash);

            // On initial load, display the form based on the current URL hash
            showFormFromHash();
        });

        // Client-side lazy validation script
        document.addEventListener("DOMContentLoaded", function () {
            // -------------------------
            // Helper functions
            // -------------------------
            function markAsValid(inputEl) {
                inputEl.classList.remove("is-invalid");
                inputEl.classList.add("is-valid");
            }

            function removeValidationClasses(inputEl) {
                inputEl.classList.remove("is-invalid", "is-valid");
            }

            function showError(inputEl, errorEl, message) {
                inputEl.classList.add("is-invalid");
                inputEl.classList.remove("is-valid");
                errorEl.textContent = message;
            }

            function clearError(inputEl, errorEl) {
                // Only mark as valid if the field has text and has been touched
                if (inputEl.dataset.touched === "true" && inputEl.value.trim() !== "") {
                    markAsValid(inputEl);
                } else {
                    removeValidationClasses(inputEl);
                }
                errorEl.textContent = "";
            }

            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            // -------------------------
            // LOGIN FORM VALIDATION
            // -------------------------
            const loginForm = document.getElementById("loginForm");
            const loginEmail = document.getElementById("loginEmail");
            const loginEmailError = document.getElementById("loginEmailError");
            const loginPassword = document.getElementById("loginPassword");
            const loginPasswordError = document.getElementById("loginPasswordError");
            const loginSubmitBtn = loginForm.querySelector('button[type="submit"]');

            function validateLoginEmail() {
                const value = loginEmail.value.trim();
                const valid = isValidEmail(value) && value !== "";
                if (loginEmail.dataset.touched === "true") {
                    if (!valid) {
                        showError(loginEmail, loginEmailError, "Please enter a valid email.");
                    } else {
                        clearError(loginEmail, loginEmailError);
                    }
                } else {
                    removeValidationClasses(loginEmail);
                    loginEmailError.textContent = "";
                }
                return valid;
            }

            function validateLoginPassword() {
                const value = loginPassword.value.trim();
                const valid = value.length >= 6;
                if (loginPassword.dataset.touched === "true") {
                    if (!valid) {
                        showError(loginPassword, loginPasswordError, "Password must be at least 6 characters.");
                    } else {
                        clearError(loginPassword, loginPasswordError);
                    }
                } else {
                    removeValidationClasses(loginPassword);
                    loginPasswordError.textContent = "";
                }
                return valid;
            }

            function validateLoginForm() {
                const emailValid = validateLoginEmail();
                const passwordValid = validateLoginPassword();
                const formValid = emailValid && passwordValid;
                loginSubmitBtn.disabled = !formValid;
                if (formValid) {
                    loginSubmitBtn.classList.remove('disabled');
                    loginSubmitBtn.classList.add('active');
                } else {
                    loginSubmitBtn.classList.add('disabled');
                    loginSubmitBtn.classList.remove('active');
                }
                return formValid;
            }

            [loginEmail, loginPassword].forEach(field => {
                field.addEventListener("blur", function () {
                    field.dataset.touched = "true";
                    validateLoginForm();
                });
                field.addEventListener("input", function () {
                    if (field.dataset.touched === "true") {
                        validateLoginForm();
                    }
                });
            });

            loginForm.addEventListener("submit", function (event) {
                loginEmail.dataset.touched = "true";
                loginPassword.dataset.touched = "true";
                if (!validateLoginForm()) {
                    event.preventDefault();
                }
            });

            // -------------------------
            // SIGNUP FORM VALIDATION
            // -------------------------
            const signupForm = document.getElementById("signupForm");
            const signupFirstName = document.getElementById("signupFirstName");
            const signupFirstNameError = document.getElementById("signupFirstNameError");
            const signupLastName = document.getElementById("signupLastName");
            const signupLastNameError = document.getElementById("signupLastNameError");
            const signupEmail = document.getElementById("signupEmail");
            const signupEmailError = document.getElementById("signupEmailError");
            const signupPassword = document.getElementById("signupPassword");
            const signupPasswordError = document.getElementById("signupPasswordError");
            const signupConfirmPassword = document.getElementById("signupConfirmPassword");
            const signupConfirmPasswordError = document.getElementById("signupConfirmPasswordError");
            const signupSubmitBtn = signupForm.querySelector('button[type="submit"]');

            function validateSignupFirstName() {
                const valid = signupFirstName.value.trim().length > 0;
                if (signupFirstName.dataset.touched === "true") {
                    if (!valid) {
                        showError(signupFirstName, signupFirstNameError, "First name is required.");
                    } else {
                        clearError(signupFirstName, signupFirstNameError);
                    }
                } else {
                    removeValidationClasses(signupFirstName);
                    signupFirstNameError.textContent = "";
                }
                return valid;
            }

            function validateSignupLastName() {
                const valid = signupLastName.value.trim().length > 0;
                if (signupLastName.dataset.touched === "true") {
                    if (!valid) {
                        showError(signupLastName, signupLastNameError, "Last name is required.");
                    } else {
                        clearError(signupLastName, signupLastNameError);
                    }
                } else {
                    removeValidationClasses(signupLastName);
                    signupLastNameError.textContent = "";
                }
                return valid;
            }

            function validateSignupEmail() {
                const value = signupEmail.value.trim();
                const valid = isValidEmail(value) && value !== "";
                if (signupEmail.dataset.touched === "true") {
                    if (!valid) {
                        showError(signupEmail, signupEmailError, "Please enter a valid email.");
                    } else {
                        clearError(signupEmail, signupEmailError);
                    }
                } else {
                    removeValidationClasses(signupEmail);
                    signupEmailError.textContent = "";
                }
                return valid;
            }

            function validateSignupPassword() {
                const value = signupPassword.value.trim();
                const valid = value.length >= 6;
                if (signupPassword.dataset.touched === "true") {
                    if (!valid) {
                        showError(signupPassword, signupPasswordError, "Password must be at least 6 characters.");
                    } else {
                        clearError(signupPassword, signupPasswordError);
                    }
                } else {
                    removeValidationClasses(signupPassword);
                    signupPasswordError.textContent = "";
                }
                return valid;
            }

            function validateSignupConfirmPassword() {
                const valid = signupConfirmPassword.value.trim() === signupPassword.value.trim() && signupConfirmPassword.value.trim() !== "";
                if (signupConfirmPassword.dataset.touched === "true") {
                    if (!valid) {
                        showError(signupConfirmPassword, signupConfirmPasswordError, "Passwords do not match.");
                    } else {
                        clearError(signupConfirmPassword, signupConfirmPasswordError);
                    }
                } else {
                    removeValidationClasses(signupConfirmPassword);
                    signupConfirmPasswordError.textContent = "";
                }
                return valid;
            }

            function validateSignupForm() {
                const firstNameValid = validateSignupFirstName();
                const lastNameValid = validateSignupLastName();
                const emailValid = validateSignupEmail();
                const passwordValid = validateSignupPassword();
                const confirmValid = validateSignupConfirmPassword();
                const formValid = firstNameValid && lastNameValid && emailValid && passwordValid && confirmValid;
                signupSubmitBtn.disabled = !formValid;
                if (formValid) {
                    signupSubmitBtn.classList.remove('disabled');
                    signupSubmitBtn.classList.add('active');
                } else {
                    signupSubmitBtn.classList.add('disabled');
                    signupSubmitBtn.classList.remove('active');
                }
                return formValid;
            }

            [
                {field: signupFirstName, validator: validateSignupFirstName},
                {field: signupLastName, validator: validateSignupLastName},
                {field: signupEmail, validator: validateSignupEmail},
                {field: signupPassword, validator: validateSignupPassword},
                {field: signupConfirmPassword, validator: validateSignupConfirmPassword}
            ].forEach(item => {
                item.field.addEventListener("blur", function () {
                    item.field.dataset.touched = "true";
                    validateSignupForm();
                });
                item.field.addEventListener("input", function () {
                    if (item.field.dataset.touched === "true") {
                        validateSignupForm();
                    }
                });
            });

            signupForm.addEventListener("submit", function (event) {
                [signupFirstName, signupLastName, signupEmail, signupPassword, signupConfirmPassword]
                    .forEach(field => field.dataset.touched = "true");
                if (!validateSignupForm()) {
                    event.preventDefault();
                }
            });
        });
